<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Slot Deutsch - Ultimate Edition</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="credits">
    Created by Ruslan Lomaka &nbsp;|&nbsp; 
    <a href="https://www.linkedin.com/in/ruslan-lomaka/" target="_blank">LinkedIn</a> &nbsp;|&nbsp; 
    <a href="https://github.com/RuslanLomaka/DerDieDasDrill" target="_blank">GitHub Repo</a>
</div>

<header>
    <h2 style="color:var(--accent); margin:0;">Slot <span style="font-weight: 300;">Deutsch</span></h2>
    <div class="controls-top">
        <select class="level-select" id="levelSelector">
            <option value="A1">Level A1 (Basic)</option>
            <option value="A2">Level A2 (Daily)</option>
            <option value="B1">Level B1 (Interm.)</option>
            <option value="B2">Level B2 (Pro)</option>
            <option value="ALL">Mix All</option>
        </select>
        <button class="pill" onclick="location.reload()">Reset</button>
    </div>
</header>

<main>
    <section>
        <div class="stage">
            <div id="reel" class="reel-container"></div>
        </div>
        <div class="controls-area">
            <div class="btnrow">
                <button class="btn der" onclick="handleChoice('der')">der</button>
                <button class="btn die" onclick="handleChoice('die')">die</button>
                <button class="btn das" onclick="handleChoice('das')">das</button>
            </div>
        </div>
    </section>

    <aside>
        <div class="stat-box">
            <div class="stat-label">Richtig / Falsch</div>
            <div class="stat-value"><span id="scoreOk" style="color:var(--ok)">0</span> / <span id="scoreBad" style="color:var(--bad)">0</span></div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Streak</div>
            <div class="stat-value" id="streak" style="color:var(--accent)">0</div>
        </div>
        <div class="stat-box" style="font-size: 13px; color: var(--muted); line-height: 1.6;">
            <b style="color:var(--text)">Vokabeln im Deck:</b><br>
            <span id="levelCount">0</span> WÃ¶rter geladen.
        </div>
    </aside>
</main>

<script src="words.js"></script>
<script>
let activeWords = [];
let currentIndex = 0;
let stats = { ok: 0, bad: 0, streak: 0 };
let isLock = false;
let activeUnit = null;
let prevUnit = null;

const levelSelector = document.getElementById('levelSelector');

function loadLevel(level) {
    if (level === "ALL") {
        activeWords = [...rawData];
    } else {
        activeWords = rawData.filter(item => item.l === level);
    }
    document.getElementById('levelCount').innerText = activeWords.length;
    shuffle(activeWords);
    currentIndex = 0;
    
    document.getElementById('reel').innerHTML = '';
    prevUnit = null;
    spawnWord("pos-active");
    currentIndex++;
    spawnWord("pos-next");
}

function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
}

function spawnWord(startPos) {
    const reel = document.getElementById('reel');
    const data = activeWords[currentIndex % activeWords.length];
    const unit = document.createElement('div');
    unit.className = `slot-unit ${startPos}`;
    unit.innerHTML = `<span class="article-reveal">${data.a}</span><span class="word-span">${data.w}</span>`;
    reel.appendChild(unit);
    if (startPos === "pos-active") activeUnit = unit;
    return unit;
}

function handleChoice(choice) {
    if (isLock || activeWords.length === 0) return;
    const currentData = activeWords[(currentIndex - 1) % activeWords.length];
    const correctArt = currentData.a;
    const isRight = choice === correctArt;

    if (!isRight) {
        activeUnit.classList.add('shake-active');
        setTimeout(() => activeUnit.classList.remove('shake-active'), 300);
        stats.bad++;
        stats.streak = 0;
        updateScore();
        return;
    }

    isLock = true;
    stats.ok++;
    stats.streak++;
    updateScore();

    activeUnit.classList.add('resolved');
    activeUnit.style.color = `var(--${correctArt})`;

    setTimeout(() => {
        const nextInLine = document.querySelector('.pos-next');
        if (prevUnit) {
            prevUnit.className = 'slot-unit pos-exit';
            const toDelete = prevUnit;
            setTimeout(() => toDelete.remove(), 700);
        }
        prevUnit = activeUnit;
        prevUnit.className = 'slot-unit pos-prev resolved'; 
        activeUnit = nextInLine;
        activeUnit.className = 'slot-unit pos-active';
        currentIndex++;
        spawnWord("pos-next");
        isLock = false;
    }, 900);
}

function updateScore() {
    document.getElementById('scoreOk').innerText = stats.ok;
    document.getElementById('scoreBad').innerText = stats.bad;
    document.getElementById('streak').innerText = stats.streak;
}

levelSelector.addEventListener('change', (e) => loadLevel(e.target.value));

window.onkeydown = (e) => {
    const key = e.key.toLowerCase();
    if (key === 'a') handleChoice('der');
    if (key === 's') handleChoice('die');
    if (key === 'd') handleChoice('das');
};

loadLevel("A1");
updateScore();
</script>
</body>
</html>
