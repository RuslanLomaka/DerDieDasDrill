<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Slot Deutsch</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <div class="credits-top">
    <span>Created by Ruslan Lomaka</span>
    <span style="opacity:.55;">|</span>
    <a href="https://www.linkedin.com/in/ruslan-lomaka/" target="_blank" rel="noopener">LinkedIn</a>
    <span style="opacity:.55;">|</span>
    <a href="https://github.com/RuslanLomaka/DerDieDasDrill" target="_blank" rel="noopener">GitHub</a>
  </div>

  <div class="header-row">
    <h2 class="app-title" style="color:var(--accent); font-size: 20px;">
      Slot <span style="font-weight: 300;">Deutsch</span>
    </h2>

    <div class="controls-top">
      <div class="level-chips" id="levelChips" aria-label="Levels">
        <button class="chip active" type="button" data-level="A1">A1</button>
        <button class="chip" type="button" data-level="A2">A2</button>
        <button class="chip" type="button" data-level="B1">B1</button>
        <button class="chip" type="button" data-level="B2">B2</button>
        <button class="chip" type="button" data-level="ALL">ALL</button>
      </div>

      <button class="pill" id="resetBtn" onclick="location.reload()">Reset</button>
    </div>
  </div>
</header>

<main>
  <div class="game-hud">
    <div class="stat-item">
      <span class="label" id="labelStreak">Streak</span>
      <span class="value" id="streak" style="color:var(--accent)">0</span>
    </div>
    <div class="stat-item">
      <span class="label" id="labelScore">Score</span>
      <span class="value">
        <span id="scoreOk" style="color:var(--ok)">0</span> : <span id="scoreBad" style="color:var(--bad)">0</span>
      </span>
    </div>
    <div class="stat-item">
      <span class="label" id="labelWords">Words</span>
      <span class="value" id="levelCount" style="color: var(--muted)">0</span>
    </div>
  </div>

  <div class="stage-wrapper">
    <div class="stage" id="stage">
      <button id="langBtn" class="lang-toggle" type="button" aria-label="Language">ðŸ‡©ðŸ‡ª</button>
      <div id="reel" class="reel-container"></div>
    </div>
  </div>

  <div class="controls-area">
    <button class="btn der" onclick="handleChoice('der')">der</button>
    <button class="btn die" onclick="handleChoice('die')">die</button>
    <button class="btn das" onclick="handleChoice('das')">das</button>
  </div>
</main>

<script src="words.js"></script>
<script>
// --- GAME LOGIC ---
let activeWords = [];
let currentIndex = 0;
let stats = { ok: 0, bad: 0, streak: 0 };
let isLock = false;
let activeUnit = null;
let prevUnit = null;

const resetBtn = document.getElementById('resetBtn');

/* =========================
   UI TRANSLATIONS
   ========================= */
const ui = {
  de: { streak: "Streak", score: "Score", words: "Words", reset: "Reset" },
  en: { streak: "Streak", score: "Score", words: "Words", reset: "Reset" },
  uk: { streak: "Ð¡ÐµÑ€Ñ–Ñ", score: "Ð Ð°Ñ…ÑƒÐ½Ð¾Ðº", words: "Ð¡Ð»Ñ–Ð²", reset: "Ð¡ÐºÐ¸Ð½ÑƒÑ‚Ð¸" }
};

/* =========================
   LANGUAGE TOGGLE
   ========================= */
const langBtn = document.getElementById('langBtn');
const LANGS = ["de", "en", "uk"];
const LANG_FLAG = { de: "ðŸ‡©ðŸ‡ª", en: "ðŸ‡¬ðŸ‡§", uk: "ðŸ‡ºðŸ‡¦" };
let currentLangIndex = 0;

function currentLang() {
  return LANGS[currentLangIndex];
}

function setLangIndex(idx) {
  currentLangIndex = (idx + LANGS.length) % LANGS.length;
  const lang = currentLang();
  langBtn.textContent = LANG_FLAG[lang] || "ðŸ³ï¸";
  applyUiLang(lang);
  refreshActiveTranslation();
}

function bumpLang() {
  setLangIndex(currentLangIndex + 1);
  langBtn.classList.remove('is-dim');
}

langBtn.addEventListener('click', bumpLang);
langBtn.addEventListener('touchstart', () => langBtn.classList.remove('is-dim'), { passive: true });

function applyUiLang(lang) {
  const t = ui[lang] || ui.de;
  document.getElementById('labelStreak').textContent = t.streak;
  document.getElementById('labelScore').textContent  = t.score;
  document.getElementById('labelWords').textContent  = t.words;
  resetBtn.textContent = t.reset;
}

/* =========================
   LEVEL CHIPS (multi-select)
   ========================= */
const levelChips = document.getElementById('levelChips');
const chipButtons = [...levelChips.querySelectorAll('.chip')];
const LEVELS = ["A1", "A2", "B1", "B2"];
let selectedLevels = new Set(["A1"]);

function setChipActive(level, isActive) {
  const btn = chipButtons.find(b => b.dataset.level === level);
  if (!btn) return;
  btn.classList.toggle('active', isActive);
}

function updateAllChipState() {
  const allOn = LEVELS.every(l => selectedLevels.has(l));
  setChipActive("ALL", allOn);
}

function rebuildWordPool() {
  if (selectedLevels.size === 0) {
    selectedLevels.add("A1");
    setChipActive("A1", true);
  }

  activeWords = rawData.filter(item => selectedLevels.has(item.l));
  document.getElementById('levelCount').innerText = activeWords.length;

  shuffle(activeWords);
  currentIndex = 0;

  document.getElementById('reel').innerHTML = '';
  prevUnit = null;

  spawnWord("pos-active");
  currentIndex++;
  spawnWord("pos-next");

  langBtn.classList.remove('is-dim');
  refreshActiveTranslation();
}

function onChipClick(level) {
  if (level === "ALL") {
    const allOn = LEVELS.every(l => selectedLevels.has(l));
    if (!allOn) {
      LEVELS.forEach(l => {
        selectedLevels.add(l);
        setChipActive(l, true);
      });
    } else {
      selectedLevels = new Set(["A1"]);
      LEVELS.forEach(l => setChipActive(l, l === "A1"));
    }
    updateAllChipState();
    rebuildWordPool();
    return;
  }

  if (selectedLevels.has(level)) {
    selectedLevels.delete(level);
    setChipActive(level, false);
  } else {
    selectedLevels.add(level);
    setChipActive(level, true);
  }

  updateAllChipState();
  rebuildWordPool();
}

levelChips.addEventListener('click', (e) => {
  const btn = e.target.closest('.chip');
  if (!btn) return;
  onChipClick(btn.dataset.level);
});

/* =========================
   TRANSLATION SUBTITLE
   ========================= */
function getTranslationFor(item, lang) {
  if (!item) return "";
  if (lang === "de") return "";
  return item.t?.[lang] || "";
}

function refreshActiveTranslation() {
  const lang = currentLang();
  if (!activeUnit) return;

  const data = activeWords[(currentIndex - 1) % activeWords.length];
  const sub = activeUnit.querySelector('.sub-translation');
  if (!sub) return;

  const txt = getTranslationFor(data, lang);
  sub.textContent = txt ? txt : "";
  sub.style.display = (txt && lang !== "de") ? "block" : "none";
}

/* =========================
   SLOT POSITIONING (never clip prev)
   ========================= */
function updateSlotPositions() {
  const stage = document.getElementById('stage');
  if (!stage) return;

  const stageH = stage.clientHeight;
  const slotH = 140; // keep synced with CSS

  // desired proportions (feel free to tweak later)
  let yNext   = Math.round(stageH * 0.06);
  let yActive = Math.round(stageH * 0.30);
  let yPrev   = Math.round(stageH * 0.62);
  let yExit   = stageH + 40;

  // hard clamps to guarantee visibility
  const maxPrev = stageH - slotH - 10;          // keep fully inside
  const minPrev = Math.max(yActive + 70, 0);    // don't overlap active

  yPrev = Math.min(yPrev, maxPrev);
  yPrev = Math.max(yPrev, minPrev);

  // keep active in reasonable range
  yActive = Math.min(yActive, Math.max(120, stageH - slotH - 60));
  yActive = Math.max(yActive, 90);

  // if stage is very short, pull next closer
  yNext = Math.min(yNext, Math.max(18, yActive - 110));

  document.documentElement.style.setProperty('--y-next',   `${yNext}px`);
  document.documentElement.style.setProperty('--y-active', `${yActive}px`);
  document.documentElement.style.setProperty('--y-prev',   `${yPrev}px`);
  document.documentElement.style.setProperty('--y-exit',   `${yExit}px`);
}

window.addEventListener('resize', updateSlotPositions);
window.addEventListener('orientationchange', () => setTimeout(updateSlotPositions, 80));

/* =========================
   CORE GAME
   ========================= */
function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
}

function spawnWord(startPos) {
  const reel = document.getElementById('reel');
  const data = activeWords[currentIndex % activeWords.length];

  const unit = document.createElement('div');
  unit.className = `slot-unit ${startPos}`;
  unit.innerHTML =
    `<div class="slot-content">` +
      `<div class="caption-row">` +
        `<span class="article-reveal">${data.a}</span>` +
        `<span class="word-span">${data.w}</span>` +
      `</div>` +
      `<div class="sub-translation"></div>` +
    `</div>`;

  reel.appendChild(unit);

  if (startPos === "pos-active") {
    activeUnit = unit;
    refreshActiveTranslation();
  } else {
    const sub = unit.querySelector('.sub-translation');
    if (sub) sub.style.display = "none";
  }

  return unit;
}

function handleChoice(choice) {
  if (isLock || activeWords.length === 0) return;

  langBtn.classList.add('is-dim');

  const currentData = activeWords[(currentIndex - 1) % activeWords.length];
  const correctArt = currentData.a;
  const isRight = choice === correctArt;

  if (!isRight) {
    activeUnit.classList.add('shake-active');
    setTimeout(() => activeUnit.classList.remove('shake-active'), 300);
    stats.bad++;
    stats.streak = 0;
    updateScore();
    return;
  }

  isLock = true;
  stats.ok++;
  stats.streak++;
  updateScore();

  activeUnit.classList.add('resolved');
  activeUnit.style.color = `var(--${correctArt})`;

  setTimeout(() => {
    const nextInLine = document.querySelector('.pos-next');

    if (prevUnit) {
      prevUnit.className = 'slot-unit pos-exit';
      const toDelete = prevUnit;
      setTimeout(() => toDelete.remove(), 700);
    }

    prevUnit = activeUnit;
    prevUnit.className = 'slot-unit pos-prev resolved';

    activeUnit = nextInLine;
    activeUnit.className = 'slot-unit pos-active';

    currentIndex++;
    spawnWord("pos-next");

    refreshActiveTranslation();
    isLock = false;
  }, 900);
}

function updateScore() {
  document.getElementById('scoreOk').innerText = stats.ok;
  document.getElementById('scoreBad').innerText = stats.bad;
  document.getElementById('streak').innerText = stats.streak;
}

window.onkeydown = (e) => {
  const key = e.key.toLowerCase();
  if (key === 'a') handleChoice('der');
  if (key === 's') handleChoice('die');
  if (key === 'd') handleChoice('das');
};

setLangIndex(0);
rebuildWordPool();
updateSlotPositions();
updateScore();
</script>
</body>
</html>
